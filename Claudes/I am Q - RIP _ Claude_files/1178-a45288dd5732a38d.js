"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1178],{16253:(e,t,r)=>{r.d(t,{XA:()=>o.XA,_F:()=>o._F,QC:()=>a.QC,cm:()=>i,eT:()=>n.e,F9:()=>n.F,cV:()=>u});var a=r(61175),n=r(52197),o=r(53478);function i(e){let{imagesEnabled:t=!1,outOfContextFilesEnabled:r=!1,wiggleEnabled:a=!1}=e,n=[];return a&&n.push(...o.rk),n.push(...o.Ap.map(e=>".".concat(e))),n.push(...o.pH.map(e=>".".concat(e))),n.push(...o.lg.map(e=>".".concat(e))),t&&n.push(...o.f9.map(e=>".".concat(e))),r&&(n.push(...o.PC.map(e=>".".concat(e))),n.push(...o.uC.map(e=>".".concat(e)))),n}var l=r(33200),s=r(1761),c=r(2341),d=r(27062);function u(){var e;let{value:t}=(0,d.fS)("ooc_attachments"),{account:r}=(0,s.YL)(),a=(0,c.B)(),n=null!=(e=null!=a?a:null==r?void 0:r.settings)?e:{},{value:o}=(0,l.N)(n);return!!t&&o}r(67422)},18179:(e,t,r)=>{r.r(t),r.d(t,{Loading:()=>l});var a=r(54568),n=r(32987),o=r(7620),i=r(62971);let l=(0,o.memo)(function(e){let{size:t="md",fullscreen:r=!1,inheritColor:l,delay:s=0}=e,[c,d]=(0,o.useState)(s>0);return(0,o.useEffect)(()=>{if(!s)return;let e=setTimeout(()=>d(!1),s);return()=>clearTimeout(e)},[s]),(0,a.jsx)("div",{className:(0,n.A)(r?"fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2":"m-auto"),children:(0,a.jsx)("div",{className:(0,n.A)("sm"===t&&"h-4 w-4 border-2","md"===t&&"h-20 w-20 border-8",l?"border-current":"border-border-200","text-secondary inline-block animate-spin rounded-full border-solid border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]",c&&"hidden"),role:"status",children:(0,a.jsx)("span",{className:"sr-only",children:(0,a.jsx)(i.A,{defaultMessage:"Loading...",id:"gjBiyjshwX"})})})})})},23661:(e,t,r)=>{r.d(t,{M:()=>n,R:()=>a});var a=function(e){return e.URLParameter="url_parameter",e.UserUpload="user_upload",e.FirstParty="first_party",e}({}),n=function(e){return e.Image="image",e.Blob="blob",e.WiggleVM="WiggleVM",e.SanitizedDocument="document",e}({})},33200:(e,t,r)=>{r.d(t,{N:()=>o});var a=r(27062),n=r(21036);function o(e){let t=(0,n.useLayer)("frontend").get("analysis_tool_experiment_enabled",!1),{value:r}=(0,a.fS)("rely_on_analysis_flag"),{value:o}=(0,a.fS)("analysis_tool_launch_ga");if(r){var i;return{value:null!=(i=null==e?void 0:e.enabled_artifacts_attachments)?i:o,source:"flag"}}return{value:(null==e?void 0:e.enabled_artifacts_attachments)||t,source:"experiment"}}},47492:(e,t,r)=>{r.d(t,{d:()=>i});var a=r(75632),n=r(7620);let o={current:(0,a.N)()};function i(){let e=(0,n.useRef)(o);return[e.current.current,()=>{e.current.current=(0,a.N)()}]}},52197:(e,t,r)=>{r.d(t,{F:()=>i,e:()=>o});var a=r(61175),n=r(53478);function o(e){let t=(0,a.QC)(e.name),r=n.pH.some(e=>e===t),o=n.eu.some(t=>t===e.type);return r||o}async function i(e){let t=await e.arrayBuffer(),r=function(e){let t=new Uint8Array(e);if(t.length>=4){if(239===t[0]&&187===t[1]&&191===t[2])return"utf-8";if(254===t[0]&&255===t[1]||255===t[0]&&254===t[1])return"utf-16";if(0===t[0]&&0===t[1]&&254===t[2]&&255===t[3]||255===t[0]&&254===t[1]&&0===t[2]&&0===t[3])return"utf-32"}let r=!1,a=Math.min(4e3,t.length),n=0,o=0;for(let e=0;e<a-1;e+=2)0===t[e]&&n++,0===t[e+1]&&o++;let i=a/8;if((n>i||o>i)&&(r=!0),r)return"utf-16";let l=0,s=0;for(let e=0;e<Math.min(1e3,t.length);e++){let r=t[e];r>127&&l++,r>=192&&r<=255&&s++}return s>.3*t.length?"windows-1251":l<.01*t.length?"ascii":"utf-8"}(t);try{return new TextDecoder(r,{fatal:!0}).decode(t)}catch(e){if("utf-8"!==r)return new TextDecoder("utf-8",{fatal:!0}).decode(t)}throw Error("Failed to decode file as plain text")}},53478:(e,t,r)=>{r.d(t,{Ap:()=>o,BA:()=>i,PC:()=>c,XA:()=>b,_F:()=>v,eu:()=>m,f9:()=>n,fT:()=>h,gZ:()=>w,h8:()=>a,hJ:()=>f,hR:()=>x,lg:()=>l,mw:()=>g,n6:()=>_,pH:()=>p,rk:()=>s,uC:()=>d,wI:()=>u,yo:()=>y});let a=["jpg","jpeg","png","gif","webp"],n=a,o=["pdf"],i=["txt","py","ipynb","js","jsx","html","css","java","cs","php","c","cc","cpp","cxx","cts","h","hh","hpp","rs","R","Rmd","swift","go","rb","kt","kts","ts","tsx","m","mm","mts","scala","dart","lua","pl","pm","t","sh","bash","zsh","csv","log","ini","cfg","config","json","proto","yaml","yml","toml","sql","bat","md","coffee","tex","latex","gd","gdshader","tres","tscn"],l=i,s=["doc","pptx","zip"],c=["csv"],d=["xls","xlsx","xlsb","xlm","xlsm","xlt","xltm","xltx","ods"],u=["bmp","ico","tiff","tif","psd","raw","cr2","nef","orf","sr2","mobi","jp2","jpx","jpm","mj2","svg","svgz","ai","eps","ps","indd","heic","mp4","mov","avi","mkv","wmv","flv","webm","mpeg","mpg","m4v","3gp","ogv","ogg","rm","rmvb","asf","amv","mpe","m1v","m2v","svi","3g2","roq","nsv","f4v","f4p","f4a","f4b","qt","hdmov","divx","div","m2ts","mts","vob","mp3","wav","wma","aac","flac","alac","aiff","opus","m4a","amr","awb","ra","mid","midi","mka","ttf","otf","woff","woff2","eot","sfnt","ttc","suit","doc","pptx","ppt","zip","rar","tar","gz","7z","pkg","deb","rpm","dmg","exe","msi","app","dng","xcf","blend","max","obj","fbx","3ds","dwg","dxf","skp","kmz"],f=[".DS_Store"],p=["docx","rtf","epub","odt","odp"],m=["application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.presentation","application/vnd.oasis.opendocument.spreadsheet","application/rtf","application/epub+zip"],h=["image/jpeg","image/png","image/gif","image/webp"],g=["application/pdf"],v={"image/jpeg":"jpg","image/png":"png","image/gif":"gif","image/webp":"webp","application/pdf":"pdf"},w=0x1e00000,y=2e3,_=2e3,x=.85,b={maxFileSize:0x1e00000,maxImageSize:0xa00000,maxFilesPerBatch:20,maxFilesPerMessage:20,maxAttachmentsPerMessage:20,maxTotalUploadsPerMessage:20,maxFilesPerConversation:100,maxAttachmentsPerConversation:500,maxTokensPerFile:1e5,maxTokensPerMessage:2e5}},61175:(e,t,r)=>{function a(e){let t=e.lastIndexOf(".");return -1===t?"":e.substring(t+1).toLowerCase()}function n(e){let t=new AbortController,r=[];for(let r of e)if(r.aborted)return t.abort(),t.signal;for(let a of e){let e=()=>{t.abort(),r.forEach(e=>e())};a.addEventListener("abort",e),r.push(()=>a.removeEventListener("abort",e))}let a=t.signal;return a.cleanup=()=>{r.forEach(e=>e())},a}function o(e,t,r){let n=a(e.name),o=t.includes(n),i=!!r&&r.includes(e.type);return o||i}r.d(t,{NA:()=>n,QC:()=>a,QL:()=>o})},67422:(e,t,r)=>{r.d(t,{e:()=>F,O:()=>U});var a=r(61175);class n{registerHandler(e){this.handlers.push(e)}async processFiles(e,t,r){let n=new AbortController,o=r?(0,a.NA)([r,n.signal]):n.signal;try{let r=this.matchFiles(e,t),a=this.validateFiles(r,t),n=a.filter(e=>e.valid),i=a.filter(e=>!e.valid),l=await this.preProcessFiles(n,t,o),s=await this.processFilesInternal(l,t,o),c=[],d=[];s.forEach(e=>{"type"in e&&"data"in e?c.push(e):"file"in e&&"error"in e&&d.push(e)});let u=[...i.map(e=>({file:e.file,error:e.error||"Validation failed"})),...d];return{successful:c,failed:u}}catch(e){throw n.abort(),e}}matchFiles(e,t){return e.map(e=>{let r=this.handlers.find(r=>r.matches(e,t));return r?{file:e,handler:r,matched:!0}:{file:e,handler:null,matched:!1,error:"No handler available for file type: ".concat(e.name)}})}validateFiles(e,t){return e.map(e=>{let{file:r,handler:a,matched:n}=e;if(!n||!a)return{file:r,handler:a,valid:!1,error:e.error||"No handler available for file: ".concat(r.name)};let o=a.validate(r,t);return{file:r,handler:a,valid:o.valid,error:o.error}})}async preProcessFiles(e,t,r){return Promise.all(e.map(async e=>{let{file:a,handler:n}=e;if(r.aborted)throw Error("Pre-processing cancelled for file: ".concat(a.name," (").concat(n.name," handler)"));let o=a;return n.preProcess&&(o=await n.preProcess(a,t,r)),{originalFile:a,processedFile:o,handler:n}}))}async processFilesInternal(e,t,r){return Promise.all(e.map(async e=>{let{processedFile:a,handler:n}=e;try{if(r.aborted)throw Error("Upload cancelled for file: ".concat(a.name," (").concat(n.name," handler)"));return await n.process(a,t,r)}catch(e){return{file:a,error:e instanceof Error?e.message:String(e)}}}))}constructor(){this.handlers=[]}}var o=r(53478),i=r(23661);function l(e){return e.replace(/\0/g,"")}async function s(e,t,r){if(!t)throw Error("Organization UUID is required for document conversion");let a=new FormData;a.append("file",e);let n=await fetch("/api/organizations/".concat(t,"/convert_document"),{method:"POST",body:a,signal:r,credentials:"include"});if(!n.ok){var o,i,s,c,d,u,f,p;if(429===n.status){let e=Error("Too many file upload attempts. Please wait and try again later.");throw e.isRateLimit=!0,e.statusCode=429,e}if(413===n.status){let e=Error("Uploaded file is too large. Try uploading a smaller part of the document, or copy/pasting an excerpt from the file.");throw e.statusCode=413,e.errorType="file_too_large",e}let t={};try{t=await n.json()}catch(e){}let r=t;if("document_password_protected"===((null==(o=r.error)?void 0:o.error_code)||(null==(i=r.error)?void 0:i.errorCode)||(null==(c=r.error)||null==(s=c.details)?void 0:s.error_code)||(null==(u=r.error)||null==(d=u.details)?void 0:d.errorCode))){let t=Error("Document is password protected");throw t.errorCode="document_password_protected",t.fileName=e.name,t}if((null==(f=r.error)?void 0:f.type)==="invalid_file_type")throw Error("Invalid file type for conversion: ".concat(e.name," (").concat(e.type,")"));let a=Error("Text extraction failed for one of the uploaded files. Please try again.");throw a.statusCode=n.status,a.errorType="extraction_failed",a.originalMessage=(null==(p=r.error)?void 0:p.message)||"Document conversion failed",a}let m=await n.json();if(!m||"object"!=typeof m)throw Error("Invalid response format for document conversion: ".concat(e.name));if(!m.file_name||!m.extracted_content)throw Error("Invalid document conversion response structure for file: ".concat(e.name," - ")+"Missing required fields (file_name or extracted_content)");return m.extracted_content=l(m.extracted_content),m.file_name=l(m.file_name),m.file_type=l(m.file_type),m}function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.gZ;if(e.size>t){let e=Math.round(t/1e6*10)/10;return{valid:!1,error:"You may not upload files larger than ".concat(e,"mb.")}}return{valid:!0}}async function d(e,t,r,a){let n=(null==a?void 0:a.handlerName)?"".concat(a.handlerName,": "):"",o=new FormData;o.append("file",e);let i=await fetch(t,{method:"POST",body:o,signal:r,credentials:"include"});if(!i.ok)throw Error("".concat(n,"Upload failed: ").concat(i.status," ").concat(i.statusText," - ")+"File: ".concat(e.name," (").concat(e.size," bytes, ").concat(e.type,") - ")+"URL: ".concat(t));let l=await i.json();if(!l||"object"!=typeof l)throw Error("".concat(n,"Invalid response format for upload: ").concat(e.name));if("type"in l&&"error"===l.type)throw Error("".concat(n,"Upload error: ").concat(l.error.message," - File: ").concat(e.name));if(!("file_kind"in l)||!("file_uuid"in l))throw Error("".concat(n,"Invalid upload response structure for file: ").concat(e.name));return l}function u(e){var t;return(null==(t=e.featureGates)?void 0:t.trials_and_tribulations_of_high_school_football)||!1}function f(e){let{orgUuid:t,conversationUuid:r}=e;if(!t||!r)throw Error("orgUuid and conversationUuid are required for wiggle uploads");return"/api/organizations/".concat(t,"/conversations/").concat(r,"/wiggle/upload-file")}async function p(e,t,r){if(!u(t))throw Error("Wiggle uploads are not enabled");return d(e,f(t),r,{handlerName:"Wiggle"})}class m{matches(e,t){var r;if(!(0,a.QL)(e,o.pH,o.eu))return!1;let n=(null==(r=e.name.split(".").pop())?void 0:r.toLowerCase())||"";return!o.rk.includes(n)||u(t)}async tryWiggleUpload(e,t,r){if(!u(t))return null;try{return(await p(e,t,r)).path||null}catch(t){return console.warn("[Wiggle Upload Failed]",{fileName:e.name,error:t instanceof Error?t.message:String(t)}),null}}validate(e,t){return c(e)}async process(e,t,r){let a=await this.tryWiggleUpload(e,t,r),n=await s(e,t.orgUuid,r);return a&&(n.path=a),{type:"attachment",data:n}}constructor(){this.name="ContentExtractorHandler",this.config={}}}class h{matches(e,t){return e.size>o.gZ}validate(e,t){let r=o.gZ/1e6;return{valid:!1,error:"You may not upload files larger than ".concat(r,"mb.")}}process(){throw Error("FileSizeHandler should never process files")}constructor(){this.name="FileSizeHandler",this.config={}}}async function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.yo,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:o.n6;if("undefined"==typeof document)return e;let a=new Image;if(a.src=URL.createObjectURL(e),await new Promise(e=>{a.onload=e,setTimeout(e,250)}),!a.width||!a.height||"image/png"!==e.type&&a.width<=t&&a.height<=r)return e;let n=a.width/a.height,i=a.width,l=a.height;a.width>t&&(l=(i=t)/n),l>r&&(i=(l=r)*n);let s=document.createElement("canvas");s.style.display="none",document.body.appendChild(s);let c=s.getContext("2d");if(!c||!c.imageSmoothingQuality)return document.body.removeChild(s),e;c.imageSmoothingQuality="high",s.width=i,s.height=l,c.drawImage(a,0,0,i,l);let d=await new Promise(e=>{s.toBlob(t=>e(t),"image/webp",o.hR)});return(document.body.removeChild(s),d)?new File([d],e.name,{type:"image/webp"}):e}function v(e,t){if(u(t))return f(t);let{orgUuid:r,projectUuid:a}=t;return a?"/api/organizations/".concat(r,"/projects/").concat(a,"/upload"):"/api/".concat(r,"/upload")}class w{matches(e,t){var r;return!!(null==(r=t.modelConfig)?void 0:r.image_in)&&(0,a.QL)(e,o.f9,o.fT)}validate(e,t){return c(e)}async preProcess(e,t,r){var a;if(r.aborted)throw Error("Image processing cancelled");return(null==(a=t.featureGates)?void 0:a.use_canvas_resize)?Promise.race([g(e,o.yo,o.n6),new Promise((e,t)=>{r.addEventListener("abort",()=>{t(Error("Image resize cancelled"))})})]):e}async process(e,t,r){if(!this.config.uploadBehavior)throw Error("ImageHandler requires uploadBehavior configuration");let a=this.config.uploadBehavior.getUploadUrl(e,t);if(!a)throw Error("Failed to get upload URL for image: ".concat(e.name," (").concat(e.size," bytes)"));return{type:"image",data:await d(e,a,r,{handlerName:"Image"})}}constructor(){this.name="ImageHandler",this.config={uploadBehavior:{getUploadUrl:v}}}}class y{matches(e,t){return(0,a.QL)(e,o.Ap,o.mw)}validate(e,t){return c(e)}async process(e,t,r){var a,n;let o=(null==(a=t.featureGates)?void 0:a.janus_claude_ai)||!1,i=(null==(n=t.modelConfig)?void 0:n.pdf_in)||!1;if(!(o&&i))return{type:"attachment",data:await this.fallbackToTextExtraction(e,t,r)};try{let a=await this.uploadPDFForRasterization(e,t,r);return{type:"file",data:a}}catch(a){if(a instanceof Error&&a.message.includes("document_too_many_pages"))return{type:"attachment",data:await this.fallbackToTextExtraction(e,t,r)};throw a}}async uploadPDFForRasterization(e,t,r){let a=new FormData;a.append("file",e);let n=v(e,t),o=await fetch(n,{method:"POST",body:a,signal:r});if(!o.ok){var i,l,s,c,d,u;let e=await o.json(),t=(null==(i=e.error)?void 0:i.error_code)||(null==(l=e.error)?void 0:l.errorCode)||(null==(c=e.error)||null==(s=c.details)?void 0:s.error_code)||(null==(u=e.error)||null==(d=u.details)?void 0:d.errorCode);if(400===o.status&&"document_too_many_pages"===t)throw Error("document_too_many_pages");throw Error("PDF upload failed: ".concat(o.status))}return await o.json()}async fallbackToTextExtraction(e,t,r){return s(e,t.orgUuid,r)}constructor(){this.name="PdfHandler",this.config={}}}class _{matches(e,t){var r;if(!(null==(r=t.featureGates)?void 0:r.ooc_attachments))return!1;let n=[...o.PC,...o.uC];return(0,a.QL)(e,n)}validate(e,t){return c(e)}async process(e,t,r){if(!this.config.uploadBehavior)throw Error("SpreadsheetHandler requires uploadBehavior configuration");let a=this.config.uploadBehavior.getUploadUrl(e,t);if(!a)throw Error("Failed to get upload URL for out-of-context file: ".concat(e.name," (").concat(e.size," bytes)"));return{type:"file",data:await d(e,a,r,{handlerName:"Out-of-context"})}}constructor(){this.name="SpreadsheetHandler",this.config={uploadBehavior:{getUploadUrl:v}}}}var x=r(52197);class b{matches(e,t){return!0}validate(e,t){return c(e)}async process(e,t,r){let a=u(t),n=null;a&&(n=await p(e,t,r));try{let a;if(!(0,x.e)(e))try{let t=await (0,x.F)(e),r={file_name:function(e){let t=e.webkitRelativePath;return t&&t.length>0?t:e.name}(e),file_type:e.type,file_size:e.size,extracted_content:t,origin:i.R.UserUpload};return a={...r,extracted_content:l(r.extracted_content),file_name:l(r.file_name),file_type:l(r.file_type)},(null==n?void 0:n.path)&&(a.path=null==n?void 0:n.path),{type:"attachment",data:a}}catch(e){}return a=await s(e,t.orgUuid,r),(null==n?void 0:n.path)&&(a.path=null==n?void 0:n.path),{type:"attachment",data:a}}catch(t){if(a&&n)return console.warn("[Text Extraction Failed, Using Wiggle]",{fileName:e.name,error:t instanceof Error?t.message:String(t)}),{type:"file",data:n};throw t}}constructor(){this.name="TextAttachmentHandler",this.config={}}}class E{matches(e,t){var r,n,i;if(u(t))return!1;if((0,a.QL)(e,o.wI)){let r=(null==(i=e.name.split(".").pop())?void 0:i.toLowerCase())||"";return!(o.rk.includes(r)&&u(t))}return!!(!(null==(r=t.modelConfig)?void 0:r.image_in)&&(0,a.QL)(e,o.f9)||!(null==(n=t.featureGates)?void 0:n.ooc_attachments)&&(0,a.QL)(e,o.uC))}validate(e,t){return{valid:!1,error:"File type is not supported"}}process(){throw Error("UnsupportedFileHandler should never process files")}constructor(){this.name="UnsupportedFileHandler",this.config={}}}function F(){let e=new n;return e.registerHandler(new E),e.registerHandler(new h),e.registerHandler(new _),e.registerHandler(new y),e.registerHandler(new m),e.registerHandler(new w),e.registerHandler(new b),e}function U(e){return e.filter(e=>!o.hJ.some(t=>t===e.name))}}}]);